name: SPFx CI/CD Pipeline

on:
  push:
    branches:
      - master  # or 'main' if you're using that

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v2

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.18.1"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ›  Install Gulp
        run: npm install gulp gulp-cli

      - name: ğŸ› ï¸ Bundle SPFx Code
        run: gulp bundle --ship

      - name: ğŸ“¦ Package SPFx Solution
        run: gulp package-solution --ship

      - name: ğŸ’¾ Upload SPPKG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-package
          path: sharepoint/solution/advanced-comments-box.sppkg

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v2

      - name: ğŸ“¥ Download SharePoint Package
        uses: actions/download-artifact@v4
        with:
          name: spfx-package
          path: sharepoint/solution/

      - name: ğŸ” M365 Login (Admin Credentials)
        id: login
        uses: pnp/action-cli-login@v2.2.1
        with:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

      - name: ğŸ§° Setup M365 CLI default appId
        run: m365 setup --appId 00000003-0000-0ff1-ce00-000000000000

      - name: ğŸš€ Deploy SPFx App to App Catalog
        run: |
          m365 spo app add --filePath sharepoint/solution/advanced-comments-box.sppkg --appCatalogUrl ${{ secrets.SPO_SITE_URL }} --overwrite

          APP_ID=$(m365 spo app get --name advanced-comments-box.sppkg --appCatalogUrl ${{ secrets.SPO_SITE_URL }} --output json | jq -r ".UniqueId")

          echo "Deploying app with ID: $APP_ID"

          m365 spo app deploy --id $APP_ID --appCatalogUrl ${{ secrets.SPO_SITE_URL }} --skipFeatureDeployment
        shell: bash
